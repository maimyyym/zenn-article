---
title: "DynamoDBæ“ä½œå‡¦ç†ã‚’è¡Œã†Lambda with TypeScriptã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’jestã§æ›¸ã"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "jest"]
published: false
publication_name: "fusic"
---
## ã“ã®è¨˜äº‹ã§è§£æ±ºã™ã‚‹ã“ã¨
- TypeScriptã§æ›¸ã‹ã‚ŒãŸã€DynamoDBæ“ä½œã‚’è¡Œã†Lambdaé–¢æ•°ã®å˜ä½“ãƒ†ã‚¹ãƒˆã‚’jestã‚’ç”¨ã„ã¦å®Ÿè¡Œã™ã‚‹æ‰‹é †
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã«æ›¸ãã¹ãè¦ç´ 

### å‰æã®è£œè¶³
ä¾‹ãˆã°`sam init`ã‚’ç”¨ã„ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ã—ãŸéš›ã«TypeScriptä½¿ç”¨ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚ã‚‰ã‹ã˜ã‚jestã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã™ã€‚
ä»Šå›ã¯ãã†ã„ã£ãŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒãªã„çŠ¶æ…‹ã€0ã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

## å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«é€²ã‚ã¾ã™ã€‚
https://jestjs.io/ja/docs/getting-started
```sh
npm install --save-dev jest
```

TypeScriptã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€Babelã‚‚ã—ãã¯ts-jestã‚’çµŒç”±ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
### Babelã‚’ä½¿ã†
:::message
**Babelã¨ã¯**
JavaScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã€‚ECMAScript2015ã€œã®ã‚³ãƒ¼ãƒ‰ã‚’å¤ã„JavaScriptã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆIEãªã©ï¼‰ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ãã‚‹ã€‚babel/preset-typescriptã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§TypeScriptã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¯èƒ½ã€‚
:::

```sh
npm install --save-dev babel-jest @babel/core @babel/preset-env
npm install --save-dev @babel/preset-typescript
```
#### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«(`babel-config.js`)ã‚’æ›¸ã
```js:babel-config.js
module.exports = {
    presets: [
        ['@babel/preset-env', {targets: {node: 'current'}}],
        '@babel/preset-typescript',],
};
```

### ts-jestã‚’ä½¿ã†
:::message
**ts-jestã¨ã¯**
jestã‚’TypeScriptã«å¯¾å¿œã•ã›ã‚‹ãŸã‚ã®ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µã€‚TypeScriptã§æ›¸ã„ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã›ãšã«ãã®ã¾ã¾å®Ÿè¡Œã§ãã‚‹ã€‚
:::

```sh
npm install --save-dev ts-jest
```
#### `@jest/globals`ã¾ãŸã¯`@types/jest`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’TypeScriptã§æ›¸ã
jestã§ä½¿ã‚ã‚Œã‚‹å‹å®šç¾©ã•ã‚ŒãŸAPIã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«`@jest/globals`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```sh
npm install --save-dev @jest/globals
```
ã“ã¡ã‚‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªã„ã¨ã€jestã®ãŸã‚ã®è¨˜è¿°ã§å‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã€‚
ã€ä¾‹ï¼šä»¥ä¸‹ã®`describe()`ãªã©ã€‘
```ts
import {describe, expect, test} from '@jest/globals';
import {sum} from './sum';

describe('sum module', () => {
  test('adds 1 + 2 to equal 3', () => {
    expect(sum(1, 2)).toBe(3);
  });
});
```
[å‚è€ƒ]ï¼šhttps://jestjs.io/ja/docs/getting-started#type-definitions

ã¾ãŸã¯ã€`@types/jest`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ãªãå‹ãŒè§£æ±ºã•ã‚Œã¾ã™ã€‚
```sh
npm install --save-dev @types/jest
```

```ts
// describeç­‰ã®importæ–‡ã¯ä¸è¦ã«ãªã‚‹
import {sum} from './sum';

describe('sum module', () => {
  test('adds 1 + 2 to equal 3', () => {
    expect(sum(1, 2)).toBe(3);
  });
});
```

### Babel VS ts-jest
Babelã¯ã‚ãã¾ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¨ã—ã¦ã®å½¹å‰²ã§ã™ã€‚Jestã‚‚ã¾ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã‚ãªã„ã¾ã›ã‚“ã€‚
å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ãŸã„å ´åˆã¯ts-jestã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ï¼ˆã‚‚ã—ãã¯TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã§ã‚ã‚‹`tsc`ã‚’åˆ¥é€”ã§ä½¿ç”¨ã™ã‚‹ã€‚
[å‚è€ƒ]ï¼šhttps://jestjs.io/ja/docs/getting-started#babel-%E7%B5%8C%E7%94%B1%E3%81%A7

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«(`jest-config.js`)
æœ€ä½é™ã€ä»¥ä¸‹ã®è¨˜è¿°ã‚’ã—ã¾ã™ã€‚
```js:jest-config.js
module.exports = {
    "roots": [
        "<rootDir>/tests/",
    ],
    "transform": {
        "^.+\\.ts": ["ts-jest", {
            tsconfig: "tsconfig.json",
        }],
    },
    "testMatch": [
        "<rootDir>/tests/**/*.test.ts",
    ],
}
```
### `roots`
jestãŒãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã™ã‚‹ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã€‚
### `transform`
ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›æ–¹æ³•ã‚’æŒ‡å®šã€‚
`^.+\\.ts`ã¯`.ts`ã§çµ‚ã‚ã‚‹å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒãƒã•ã›ã€`ts-jest`ã«ã‚ˆã‚Š`tsconfig.json`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨ã„ã¦TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ã„ã†æ–¹æ³•ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
### `testMatch`
ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ‰±ã†ã‹æŒ‡å®šã€‚

## package.json
`npm run test`ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«package.jsonã‚‚è¨˜è¿°ã—ã¾ã™ã€‚
```json:package.json
    "scripts": {
        "test": "jest"
    },
```

## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæº–å‚™
ã“ã“ã¾ã§ã¯jestã®è¨­å®šã§ã—ãŸã€‚
æ—©é€Ÿãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚
**â€»ä»Šå›ã¯ts-jestã‚’ç”¨ã„ã¦é€²ã‚ã¦ã„ãã¾ã™**

### ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰
DynamoDBã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’scanã—ã¦ãã®ã¾ã¾è¿”ã™lambdaé–¢æ•°ã‚’ä¾‹ã¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚

```ts:src/app.ts
import { APIGatewayProxyEvent, APIGatewayProxyResult } from "aws-lambda";
import { DynamoDBClient, DynamoDBClientConfig } from "@aws-sdk/client-dynamodb";
import { DynamoDBDocumentClient, ScanCommand, ScanCommandInput, ScanCommandOutput } from "@aws-sdk/lib-dynamodb";

const options: DynamoDBClientConfig = {
    endpoint: process.env.DYNAMODB_ENDPOINT
}

const docClient = DynamoDBDocumentClient.from(new DynamoDBClient(options));

export const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
    const params: ScanCommandInput = {
        TableName : 'hoge-table',
    };
    const command = new ScanCommand(params);
    const result: ScanCommandOutput = await docClient.send(command);

    return {
        statusCode: 200,
        body: JSON.stringify(result.Items),
    };
}
```

### ã“ã“ã§ç§ãŒç–‘å•ã«æ€ã£ãŸã“ã¨ã¨ç­”ãˆï¼ˆDynamoDBã®ãƒ¢ãƒƒã‚¯ï¼‰
DynamoDBå‡¦ç†ã‚’è¡Œã†é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„ãŒã€ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã®ã‚ˆã†ã«ç”¨æ„ã™ã‚‹ã®ã ã‚ã†ï¼Ÿã©ã“ã«ã©ã†ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”¨æ„ã™ã‚‹ã®ã ã‚ã†ï¼Ÿãƒ¢ãƒƒã‚¯ã®ä½¿ã„æ–¹ã¯ï¼Ÿã¨æ€ã„ã¾ã—ãŸã€‚

Lambdaé–¢æ•°ã§DynamoDBæ“ä½œã‚’è¡Œã†ãŸã‚ã«AWS SDKã‚’ä½¿ç”¨ã—ã¾ã™ã€‚SDKã‚’ç”¨ã„ãŸæ“ä½œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€`aws-sdk-client-mock`ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
```sh
npm install --save-dev aws-sdk-client-mock
```

#### å‚è€ƒ
https://aws.amazon.com/jp/blogs/developer/mocking-modular-aws-sdk-for-javascript-v3-in-unit-tests/

### aws-sdk-client-mockã‚’ç”¨ã„ã¦ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã

#### ã¾ãšã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
```ts

```

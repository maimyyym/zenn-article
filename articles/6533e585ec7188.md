---
title: "DynamoDB操作処理を行うLambda with TypeScriptのテストコードをjestで書く"
emoji: "🐥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws", "jest"]
published: false
publication_name: "fusic"
---
## この記事で解決すること
- TypeScriptで書かれた、DynamoDB操作を行うLambda関数の単体テストをjestを用いて実行する手順
- テストコードに書くべき要素

### 前提の補足
例えば`sam init`を用いてプロジェクトを初期化した際にTypeScript使用を指定するとあらかじめjestを実行できるようにセットアップされています。
今回はそういったセットアップがない状態、0からのテスト環境構築を想定しています。

## 必要なパッケージのインストール
こちらのドキュメントを参考に進めます。
https://jestjs.io/ja/docs/getting-started
```sh
npm install --save-dev jest
```

TypeScriptを使用する場合、Babelもしくはts-jestを経由する必要があります。
### Babelを使う
:::message
**Babelとは**
JavaScriptコンパイラ。ECMAScript2015〜のコードを古いJavaScriptエンジン（IEなど）で実行できるようにコンパイルできる。babel/preset-typescriptを使用することでTypeScriptのコンパイルが可能。
:::

```sh
npm install --save-dev babel-jest @babel/core @babel/preset-env
npm install --save-dev @babel/preset-typescript
```
#### 設定ファイル(`babel-config.js`)を書く
```js:babel-config.js
module.exports = {
    presets: [
        ['@babel/preset-env', {targets: {node: 'current'}}],
        '@babel/preset-typescript',],
};
```

### ts-jestを使う
:::message
**ts-jestとは**
jestをTypeScriptに対応させるためのプリプロセッサ。TypeScriptで書いたテストコードをコンパイルせずにそのまま実行できる。
:::

```sh
npm install --save-dev ts-jest
```
#### `@jest/globals`または`@types/jest`をインストールしてテストコードをTypeScriptで書く
jestで使われる型定義されたAPIを使用するために`@jest/globals`をインストールします。
```sh
npm install --save-dev @jest/globals
```
こちらをインストールしないと、jestのための記述で型エラーが発生。
【例：以下の`describe()`など】
```ts
import {describe, expect, test} from '@jest/globals';
import {sum} from './sum';

describe('sum module', () => {
  test('adds 1 + 2 to equal 3', () => {
    expect(sum(1, 2)).toBe(3);
  });
});
```
[参考]：https://jestjs.io/ja/docs/getting-started#type-definitions

または、`@types/jest`をインストールするとインポートすることなく型が解決されます。
```sh
npm install --save-dev @types/jest
```

```ts
// describe等のimport文は不要になる
import {sum} from './sum';

describe('sum module', () => {
  test('adds 1 + 2 to equal 3', () => {
    expect(sum(1, 2)).toBe(3);
  });
});
```

### Babel VS ts-jest
Babelはあくまでコンパイラとしての役割です。Jestもまたテストコードの型チェックを行わないません。
型チェックを行いたい場合はts-jestを使用します。（もしくはTypeScriptコンパイラである`tsc`を別途で使用する。
[参考]：https://jestjs.io/ja/docs/getting-started#babel-%E7%B5%8C%E7%94%B1%E3%81%A7

## 設定ファイル(`jest-config.js`)
最低限、以下の記述をします。
```js:jest-config.js
module.exports = {
    "roots": [
        "<rootDir>/tests/",
    ],
    "transform": {
        "^.+\\.ts": ["ts-jest", {
            tsconfig: "tsconfig.json",
        }],
    },
    "testMatch": [
        "<rootDir>/tests/**/*.test.ts",
    ],
}
```
### `roots`
jestがテストファイルを検索するルートディレクトリを指定。
### `transform`
ファイルの変換方法を指定。
`^.+\\.ts`は`.ts`で終わる全てのファイルをマッチさせ、`ts-jest`により`tsconfig.json`ファイルを用いてTypeScriptコンパイルするという方法を指定しています。
### `testMatch`
どのファイルをテストファイルとして扱うか指定。

## package.json
`npm run test`で実行できるようにpackage.jsonも記述します。
```json:package.json
    "scripts": {
        "test": "jest"
    },
```

## テストコードを書く準備
ここまではjestの設定でした。
早速テストコードを書いてみます。
**※今回はts-jestを用いて進めていきます**

### テスト対象のコード
DynamoDBのテーブルからデータをscanしてそのまま返すlambda関数を例として作成します。

```ts:src/app.ts
import { APIGatewayProxyEvent, APIGatewayProxyResult } from "aws-lambda";
import { DynamoDBClient, DynamoDBClientConfig } from "@aws-sdk/client-dynamodb";
import { DynamoDBDocumentClient, ScanCommand, ScanCommandInput, ScanCommandOutput } from "@aws-sdk/lib-dynamodb";

const options: DynamoDBClientConfig = {
    endpoint: process.env.DYNAMODB_ENDPOINT
}

const docClient = DynamoDBDocumentClient.from(new DynamoDBClient(options));

export const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
    const params: ScanCommandInput = {
        TableName : 'hoge-table',
    };
    const command = new ScanCommand(params);
    const result: ScanCommandOutput = await docClient.send(command);

    return {
        statusCode: 200,
        body: JSON.stringify(result.Items),
    };
}
```

### ここで私が疑問に思ったことと答え（DynamoDBのモック）
DynamoDB処理を行う関数をテストしたいが、テストのためのデータをどのように用意するのだろう？どこにどうテーブルを用意するのだろう？モックの使い方は？と思いました。

Lambda関数でDynamoDB操作を行うためにAWS SDKを使用します。SDKを用いた操作をテストするために、`aws-sdk-client-mock`というパッケージが用意されています。

#### インストールする
```sh
npm install --save-dev aws-sdk-client-mock
```

#### 参考
https://aws.amazon.com/jp/blogs/developer/mocking-modular-aws-sdk-for-javascript-v3-in-unit-tests/

### aws-sdk-client-mockを用いてテストコードを書く

#### まずはテストコード
```ts

```

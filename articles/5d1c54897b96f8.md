---
title: "ã€SDK for JavaScript v3ã€‘TypeScriptã§DynamoDBã«CRUDã™ã‚‹ã€SAMã€‘"
emoji: "ğŸ¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["sdk", "TypeScript", "aws"]
published: true
publication_name: "fusic"
---
## ã“ã®è¨˜äº‹ã®ç›®çš„
- AWS SAMã‚’ä½¿ã£ã¦API Gateway + Lambda + DynamoDBã‚’ä½œæˆã™ã‚‹
- TypeScriptã‚’ä½¿ã£ã¦DynamoDBã‚’æ“ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹ãŒåˆ†ã‹ã‚‹ï¼ˆwith **AWS SDK for JavaScript**ï¼‰

## ã“ã®è¨˜äº‹ã§è©±ã•ãªã„ã“ã¨
AWS SAMã®ç’°å¢ƒæ§‹ç¯‰ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã™ã§ã«ã‚ã‚‹ã‚‚ã®ã¨ã™ã‚‹ï¼‰

## ã“ã®è¨˜äº‹ã§ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹
![](/images/20240315_samcrud_1.png)

## AWS SAMã§ãƒªã‚½ãƒ¼ã‚¹å®šç¾©ï¼ˆtemlate.yamlã‚’è¦‹ã‚‹ï¼‰
:::details template.yaml
```yaml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: |
  dynamo-test
Globals:
  Function:
    CodeUri: src/
    Runtime: nodejs20.x
    Timeout: 180
    Architectures:
      - x86_64
    Environment:
      Variables:
        CRUDTABLE_TABLE_NAME: !Ref CRUDTable
        CRUDTABLE_TABLE_ARN: !GetAtt CRUDTable.Arn
Resources:
  CreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: create.lambdaHandler
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref CRUDTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CRUDTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /create
            Method: post
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - create.ts
  ReadFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: read.lambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CRUDTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CRUDTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /read/{id}
            Method: get
            RequestParameters:
              - method.request.path.id
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - read.ts
  UpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: update.lambdaHandler
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref CRUDTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CRUDTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /update/{id}
            Method: post
            RequestParameters:
              - method.request.path.id
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - update.ts
  DeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: delete.lambdaHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CRUDTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CRUDTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /delete/{id}
            Method: delete
            RequestParameters:
              - method.request.path.id
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - delete.ts
  CRUDTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      TableName: CRUDTable
```
:::


**â†“ãƒã‚¤ãƒ³ãƒˆã¨ãªã£ãŸã“ã¨ã®å‚™å¿˜éŒ²**
### Globalsã‚»ã‚¯ã‚·ãƒ§ãƒ³
ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã®AWS SAMãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«è¨­å®šã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚
`AWS::Serverless::Api`
`AWS::Serverless::Function`
`AWS::Serverless::HttpApi`
`AWS::Serverless::SimpleTable`
`AWS::Serverless::StateMachine`
ä¾‹ãˆã°å„Lambdaé–¢æ•°ã§ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ãªã©å…±é€šã®è¨­å®šã‚’ä½¿ç”¨ã™ã‚‹éš›ã«å„`AWS::Serverless::Function`ãƒªã‚½ãƒ¼ã‚¹å†…ã§å®šç¾©ã‚’ç¹°ã‚Šè¿”ã—è¨˜è¿°ã›ãšã«æ¸ˆã¿ã¾ã™ã€‚
:::message
è¦‹ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼š[AWS SAM ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã® Globals ã‚»ã‚¯ã‚·ãƒ§ãƒ³](https://docs.aws.amazon.com/ja_jp/serverless-application-model/latest/developerguide/sam-specification-template-anatomy-globals.html)
:::

### ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹
#### ã‚³ãƒ¼ãƒ‰
```yaml
  Events:
    Api:
      Type: Api
      Properties:
        Path: /read/{id}
        Method: get
        RequestParameters:
          - method.request.path.id
```
**ã€ãƒã‚¤ãƒ³ãƒˆã€‘**
- å„é–¢æ•°å®šç¾©ã®APIã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§`Path`ã«`{id}`ã¨ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹
- åŒã˜ããƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§`RequestParameters`ã‚’æŒ‡å®šã™ã‚‹
- å‚è€ƒï¼š[Api - AWS Serverless Application Model](https://docs.aws.amazon.com/ja_jp/serverless-application-model/latest/developerguide/sam-property-function-api.html)

## AWS SDK for JavaScript v3ã®æº–å‚™
[AWS SDK for JavaScript v3](https://github.com/aws/aws-sdk-js-v3)ã‚’ä½¿ã„ã¾ã™ã€‚
```sh
npm install @aws-sdk/client-dynamodb
```
:::message
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯[ã“ã¡ã‚‰](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/dynamodb/)
:::

## TypeScriptã§DynamoDBã«CRUDã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹
### ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã“ã‚“ãªæ„Ÿã˜
![](/images/20240315_samcrud_2.png)

### ã‚³ãƒ¼ãƒ‰ã®æµã‚Œ
- DynamoDBClientã‚’åˆæœŸåŒ–ã™ã‚‹
  ï¼ˆä¾‹ï¼‰`const client = new DynamoDBClient({});`
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å®šç¾©ã—ã¦å¤‰æ•°ã«æ ¼ç´
  ï¼ˆä¾‹ï¼‰`const xxxRequest = ...`
- â†‘ã§å®šç¾©ã—ãŸå€¤ã‚’å¼•æ•°ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  ï¼ˆä¾‹ï¼‰`const command = new GetItemCommand(commans);`
- `await client.send(command);`ã§DynamoDBæ“ä½œï¼

### ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹
:::details é …ç›®ã®æ›¸ãè¾¼ã¿
```ts
import { DynamoDBClient, WriteRequest, BatchWriteItemCommand } from '@aws-sdk/client-dynamodb';

const client = new DynamoDBClient({ region: 'ap-northeast-1' });
const tableName = 'CRUDTable';
const writeRequests: WriteRequest[] = [
    {
        PutRequest: {
            Item: {
                id: { S: '1' }, // å®Ÿéš›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å—ã‘å–ã£ãŸå€¤ã‚’ä½¿ç”¨
                name: { S: 'John' }, // å®Ÿéš›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§å—ã‘å–ã£ãŸå€¤ã‚’ä½¿ç”¨

            },
        },
    },
    {
        PutRequest: {
            Item: {
                id: { S: '2' }, // å®Ÿéš›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å—ã‘å–ã£ãŸå€¤ã‚’ä½¿ç”¨
                name: { S: 'Alice' }, // å®Ÿéš›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§å—ã‘å–ã£ãŸå€¤ã‚’ä½¿ç”¨

            },
        },
    },
];

const command = new BatchWriteItemCommand({ RequestItems: { [tableName]: writeRequests } });
await client.send(command);
```
:::

:::details é …ç›®ã®èª­ã¿å–ã‚Š
```ts
import { DynamoDBClient, GetItemCommandInput, GetItemCommand } from '@aws-sdk/client-dynamodb';

const client = new DynamoDBClient({ region: 'ap-northeast-1' });
const tableName = 'CRUDTable';

const getRequest: GetItemCommandInput = {
  TableName: tableName,
  Key: {
    id: { S: 1 }, // å®Ÿéš›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å—ã‘å–ã£ãŸå€¤ã‚’ä½¿ç”¨
  },
};

const command = new GetItemCommand(getRequest);
const { Item } = await client.send(command);
```
:::

:::details é …ç›®ã®æ›´æ–°
```ts
import { DynamoDBClient, UpdateItemInput, UpdateItemCommand } from '@aws-sdk/client-dynamodb';

const client = new DynamoDBClient({ region: 'ap-northeast-1' });
const tableName = 'CRUDTable';

const updateRequests: UpdateItemInput = {
  TableName: tableName,
  Key: {
    id: { S: 1 }, // å®Ÿéš›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å—ã‘å–ã£ãŸå€¤ã‚’ä½¿ç”¨
  },
  UpdateExpression: "set #name = :name",
  ExpressionAttributeNames: {
    "#name": "name",
  },
  ExpressionAttributeValues: {
    ":name": {
      S: "Katy", // å®Ÿéš›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§å—ã‘å–ã£ãŸå€¤ã‚’ä½¿ç”¨
    },
  },
};

const command = new UpdateItemCommand(updateRequests);
await client.send(command);
```
:::

:::details é …ç›®ã®å‰Šé™¤
```ts
import { DynamoDBClient, DeleteItemInput, DeleteItemCommand } from '@aws-sdk/client-dynamodb';

const client = new DynamoDBClient({ region: 'ap-northeast-1' });
const tableName = 'CRUDTable';

const deleteRequests: DeleteItemInput = {
  TableName: tableName,
  Key: {
    id: { S: 1 }, // å®Ÿéš›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å—ã‘å–ã£ãŸå€¤ã‚’ä½¿ç”¨
  },
};
const command = new DeleteItemCommand(deleteRequests);
await client.send(command);
```
:::

### æ”¹ã‚ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæµã‚Œã‚’æŒ¯ã‚Šè¿”ã‚‹
ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œè‡ªä½“ã¯`DynamoDBClient`ã®`send`ãƒ¡ã‚½ãƒƒãƒ‰ã«Commandã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã™ã€‚Commandã®å®šç¾©ã«ã¤ã„ã¦ã¯[å…¬å¼APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/dynamodb/)ã‚’å‚ç…§ã—ã¤ã¤[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ä¾‹](https://docs.aws.amazon.com/code-library/latest/ug/dynamodb_code_examples.html)ã‚’å‚è€ƒã«æ›¸ã„ã¦ã„ãã€‚ã“ã®æµã‚ŒãŒåŸºæœ¬ã«ãªã‚Šã¾ã™ã€‚
:::message
å‹ã¯ã©ã†ãªã‚‹ã®ï¼Ÿ
APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã®å„Commandã®ãƒšãƒ¼ã‚¸å†…ã€`Example`é …ç›®ã®ä¸‹ã«Input,Output,Throwsã«ã¤ã„ã¦ãã‚Œãã‚Œè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
ï¼ˆä¾‹ï¼‰[UpdateItemCommand](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/dynamodb/command/UpdateItemCommand/)
:::

## ã¾ã¨ã‚
SDKã‚’ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã“ã†ã¨ã™ã‚‹ã¨ã€ã„ã¤ã‚‚ã€Œã‚ã‚Œã€ã©ã†æ›¸ã‘ã°ã„ã„ã‚“ã ã£ã‘ï¼Ÿãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã©ã“ï¼Ÿçµå±€ã©ã‚ŒãŒæ­£ã—ã„ã®ï¼Ÿã€ã¨ã„ã†æ°—æŒã¡ã«ãªã‚Šã¾ã™ã€‚ï¼ˆSDKã«é™ã£ãŸè©±ã§ã‚‚ãªã„â€¦ï¼‰
SDK for JavaScript v3ã®APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã¯è¦‹æ–¹ãŒåˆ†ã‹ã‚‹ã¨èª­ã¿ã‚„ã™ã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚ã¨ã¯ã„ãˆæ¯å›å¿˜ã‚Œã¦ã„ã‚‹ã®ã§ã€åŸºæœ¬ã®æµã‚Œã¨ä½•ã‚’å‚ç…§ã™ã‚Œã°ã„ã„ã‚“ã ã£ã‘ï¼Ÿã‚’ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚
æƒ…å ±ãŒè†¨å¤§ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯èª­ã¿æ…£ã‚Œã‚‹ã®ã‚‚ä¸€è‹¦åŠ´ãªã®ã§ã€ã“ã‚Œã‹ã‚‰ã‚‚ä¸€åº¦è¦šãˆãŸèª­ã¿æ–¹ã‚’å‚™å¿˜éŒ²ã¨ã—ã¦ã¾ã¨ã‚ã‚‹ç¿’æ…£ã‚’ã¤ã‘ãŸã„ã¨æ€ã„ã¾ã™ã€‚
